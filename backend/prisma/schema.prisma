generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id           String         @id @default(uuid())
  email        String         @unique
  passwordHash String
  isAdmin      Boolean        @default(false)
  kycStatus    String         @default("pending") // pending, verified, rejected
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  
  // Relations
  balance      UserBalance?
  ledgers      Ledger[]
  payouts      Payout[]
  kycDocuments KycDocument[]
}

// ============================================
// GOLD INVENTORY (Physical Gold Pools)
// ============================================

model Pool {
  id             String   @id @default(uuid())
  name           String
  totalGrams     Decimal  @db.Decimal(18, 6)  // Original amount of gold
  availableGrams Decimal  @db.Decimal(18, 6)  // Current available to sell
  purity         String                         // e.g., "24k", "22k"
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  ledgers        Ledger[]
}

// ============================================
// USER GOLD HOLDINGS
// ============================================

model UserBalance {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  grams       Decimal  @default(0) @db.Decimal(18, 6)  // Total gold owned
  lockedGrams Decimal  @default(0) @db.Decimal(18, 6)  // Locked during pending sell
  updatedAt   DateTime @updatedAt
}

// ============================================
// TRANSACTION HISTORY (Immutable Ledger)
// ============================================

model Ledger {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type         String   // buy, sell, credit, debit, adjustment
  grams        Decimal  @db.Decimal(18, 6)
  pricePerGram Decimal  @db.Decimal(18, 2)  // KES per gram at time of transaction
  totalKes     Decimal  @db.Decimal(20, 2)  // Total KES amount
  poolId       String?
  pool         Pool?    @relation(fields: [poolId], references: [id])
  reference    String   // M-Pesa transaction ID or internal reference
  status       String   // pending, completed, failed
  createdAt    DateTime @default(now())
  
  @@index([userId, createdAt])
  @@index([status])
}

// ============================================
// GOLD PRICES (Buy/Sell Rates)
// ============================================

model Price {
  id               String   @id @default(uuid())
  buyPricePerGram  Decimal  @db.Decimal(18, 2)  // Price users buy at (KES/gram)
  sellPricePerGram Decimal  @db.Decimal(18, 2)  // Price users sell at (KES/gram)
  effectiveFrom    DateTime @default(now())
  createdBy        String   // Admin user ID who set the price
  createdAt        DateTime @default(now())
  
  @@index([effectiveFrom])
}

// ============================================
// PAYOUTS (Sell Transactions)
// ============================================

model Payout {
  id                 String    @id @default(uuid())
  userId             String
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  amountKes          Decimal   @db.Decimal(20, 2)
  phone              String
  status             String    // pending, processing, completed, failed
  mpesaTransactionId String?
  notes              String?   // Admin notes or failure reason
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  
  @@index([userId, status])
  @@index([status])
}

// ============================================
// KYC DOCUMENTS
// ============================================

model KycDocument {
  id         String    @id @default(uuid())
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  docType    String    // id_front, id_back, selfie
  s3Path     String    // Cloud storage path
  verified   Boolean   @default(false)
  verifiedBy String?   // Admin user ID who verified
  verifiedAt DateTime?
  notes      String?   // Admin notes
  createdAt  DateTime  @default(now())
  
  @@index([userId, verified])
}
